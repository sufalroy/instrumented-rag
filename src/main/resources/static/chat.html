<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrumented RAG Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        chatbg: '#1a1a1a',
                        usermsg: '#2a2a2a',
                        botmsg: '#252525',
                        systemmsg: '#332200',
                    },
                },
            },
        }
    </script>
    <style>
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message-content code {
            background-color: #333;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-chatbg text-gray-100 min-h-screen flex flex-col">
<div class="container mx-auto p-4 flex-1 flex flex-col max-w-4xl">
    <h1 class="text-2xl sm:text-3xl font-bold mb-4 text-center text-blue-400">Instrumented RAG Chatbot</h1>

    <div id="chat-messages"
         class="flex-1 overflow-y-auto mb-4 p-2 sm:p-4 bg-gray-800 rounded-lg shadow space-y-2"></div>

    <form id="chat-form" class="flex items-center">
        <input
                type="text"
                id="message-input"
                placeholder="Type your message..."
                class="flex-1 p-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
        >
        <button
                type="submit"
                class="bg-blue-600 text-gray-100 p-2 rounded-r-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                 class="lucide lucide-send">
                <line x1="22" x2="11" y1="2" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
        </button>
    </form>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    const documentId = 'c63594f3-29a2-47d6-98c1-602204b8a96e';

    chatForm.addEventListener('submit', handleSubmit);

    async function handleSubmit(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        addMessageToChat('User', message);
        messageInput.value = '';
        messageInput.disabled = true;

        try {
            const response = await fetch(`http://localhost:8080/api/assistant/${documentId}?message=${encodeURIComponent(message)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const reader = response.body.getReader();
            const botMessageElement = addMessageToChat('Bot', '');
            const contentElement = botMessageElement.querySelector('.message-content');

            await streamResponse(reader, contentElement);
        } catch (error) {
            console.error('Error fetching chatbot response:', error);
            addMessageToChat('System', 'An error occurred while fetching the response. Please try again.');
        } finally {
            messageInput.disabled = false;
            messageInput.focus();
        }
    }

    async function streamResponse(reader, contentElement) {
        const decoder = new TextDecoder();
        while (true) {
            const {done, value} = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, {stream: true});
            contentElement.innerHTML += chunk;
            scrollToBottom();
        }
    }

    function addMessageToChat(sender, content) {
        const messageElement = document.createElement('div');
        messageElement.className = `p-3 rounded-lg flex items-start ${getBackgroundColor(sender)}`;
        messageElement.innerHTML = `
                <div class="mr-3 mt-1">${getIcon(sender)}</div>
                <div class="flex-1">
                    <div class="font-bold">${sender}:</div>
                    <div class="message-content">${content}</div>
                </div>
            `;
        chatMessages.appendChild(messageElement);
        scrollToBottom();
        return messageElement;
    }

    function getBackgroundColor(sender) {
        switch (sender) {
            case 'User':
                return 'bg-usermsg';
            case 'Bot':
                return 'bg-botmsg';
            case 'System':
                return 'bg-systemmsg';
            default:
                return 'bg-usermsg';
        }
    }

    function getIcon(sender) {
        switch (sender) {
            case 'User':
                return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
            case 'Bot':
                return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>';
            case 'System':
                return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>';
            default:
                return '';
        }
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    const adjustHeight = debounce(() => {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }, 100);

    window.addEventListener('resize', adjustHeight);
    adjustHeight();
</script>
</body>
</html>